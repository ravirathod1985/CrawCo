{
  "description": "This rule is used by the Web Services connector to update parsed resource object. Create List of Objects which will later converted to Resource object.",
  "type": "WebServiceAfterOperationRule",
  "signature": {
    "input": [
      {
        "name": "application",
        "description": "The application whose data file is being processed.",
        "type": null
      },
      {
        "name": "requestEndPoint",
        "description": "The current request information contain header, body ,response object",
        "type": null
      },
      {
        "name": "processedResponseObject",
        "description": "Response Object processed by the Web services connector",
        "type": null
      },
      {
        "name": "rawResponseObject",
        "description": "Response Object returned from the end system",
        "type": null
      },
      {
        "name": "restClient",
        "description": "REST Client Object",
        "type": null
      }
    ],
    "output": {
      "name": "Update Account/Group List",
      "description": "Update information Map contains parsed list of accounts",
      "type": null
    }
  },
  "sourceCode": {
    "version": "1.0",
    "script": "import java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\nimport sailpoint.tools.GeneralException;\nimport connector.common.JsonUtil;\n\npublic Map getEmployeesAssignments(){\n    StringBuilder sbLogMessages = new StringBuilder();\n\n    ArrayList<String> specialAttributesFromWorkrelation = new ArrayList<String>(\n            Arrays.asList(\"StartDate\", \"LegislationCode\", \"LegalEntityId\", \"TerminationDate\", \"WorkerType\",\"LegalEmployerName\"));\n\n    ArrayList<String> specialAttributesFromAssignment = new ArrayList<String>(\n            Arrays.asList(\"ActionCode\", \"BusinessUnitId\", \"DepartmentId\", \"EffectiveEndDate\", \"EffectiveStartDate\",\n                    \"JobId\", \"LocationId\", \"AssignmentName\", \"AssignmentNumber\", \"PositionId\",\n                    \"AssignmentStatusType\", \"AssignmentStatusTypeId\", \"DepartmentName\"));\n\n    Map EmployeesAssignments = new HashMap();\n\n    Map response = JsonUtil.toMap(rawResponseObject);\n\n    try{\n        if (response.get(\"items\") != null) {\n            List items = (ArrayList) response.get(\"items\");\n            for (int d = 0; d < items.size(); d++) {\n                Map worker = (Map) items.get(d);\n                // items[d].workrelationships.items[e].assignments.items[f]\n                if (((Map) worker.get(\"workRelationships\")).get(\"items\") != null) {\n                    List workRelationships = (ArrayList) ((Map) worker.get(\"workRelationships\")).get(\"items\");\n                    for (int e = 0; e < workRelationships.size(); e++) {\n                        Map workRelation = (Map) workRelationships.get(e);\n                        if (((Map) workRelation.get(\"assignments\")).get(\"items\") != null) {\n                            List assignments = (ArrayList) ((Map) workRelation.get(\"assignments\")).get(\"items\");\n                            for (int f = 0; f < assignments.size(); f++) {\n                                Map assignment = (Map) assignments.get(f);\n                                String key = \"\";\n                                key = worker.get(\"PersonNumber\") + \"|\" + String.valueOf(assignment.get(\"AssignmentNumber\"));\n                                Map newMap = new HashMap();\n                                newMap.put(\"PersonNumber\", String.valueOf(worker.get(\"PersonNumber\")));\n                                newMap.put(\"PeriodOfServiceId\", String.valueOf(workRelation.get(\"PeriodOfServiceId\")));\n                                newMap.put(\"AssignmentNumber\", (String) assignment.get(\"AssignmentNumber\"));\n                                for (String attName : specialAttributesFromWorkrelation) {\n                                    String attValue = null;\n                                    if (workRelation.get(attName) != null){\n                                        attValue = String.valueOf(workRelation.get(attName));\n                                    }\n                                    newMap.put(attName, attValue);\n                                }\n                                for (String attName : specialAttributesFromAssignment) {\n                                    String attValue = null;\n                                    if (assignment.get(attName) != null){\n                                        attValue = String.valueOf(assignment.get(attName));\n                                    }\n                                    newMap.put(attName, attValue);\n                                }\n\t\t\t\t\t\t\t\t\n                                EmployeesAssignments.put(key, newMap);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        return EmployeesAssignments;\n    } catch (Exception e) {\n        sbLogMessages.append(\"@getEmployeesAssignments\" + System.lineSeparator());\n        throw new GeneralException (sbLogMessages + \"; Error: \" + e);\n    }\n}\n\npublic Map Main(){\n    Map updatedMapInfo = new HashMap();\n    StringBuilder sbLogMessages = new StringBuilder();\n    \n    // sbLogMessages.append(\"processedResponseObject: \" + processedResponseObject.toString() + System.lineSeparator());\n    // sbLogMessages.append(\"rawResponseObject: \" + rawResponseObject.toString() + System.lineSeparator());\n    // throw new GeneralException (sbLogMessages.toString());\n\n    ArrayList<String> specialAttributes = new ArrayList<String>(Arrays.asList(\n        \"ASSIGNMENT_ACTION_CODE\",\n        \"ASSIGNMENT_BUSINESS_UNIT_ID\",\n        \"ASSIGNMENT_DEPARTMENT_ID\",\n        \"ASSIGNMENT_EFFECTIVE_END_DATE\",\n        \"ASSIGNMENT_EFFECTIVE_START_DATE\",\n        \"ASSIGNMENT_JOB_ID\",\n        \"ASSIGNMENT_LOCATION_ID\",\n        \"ASSIGNMENT_NAME\",\n        \"ASSIGNMENT_NUMBER\",\n        \"ASSIGNMENT_POSITION_ID\",\n        \"ASSIGNMENT_STATUS\",\n        \"ASSIGNMENT_STATUS_TYPE_ID\",\n        \"DEPARTMENT_NAME\",\n        \"HIRE_DATE\",\n        \"LEGAL_ENTITY_ID\",\n        \"LEGISLATION_CODE\",\n        \"WORKER_TYPE\",\n        \"TERMINATION_DATE\",\n        \"LEGAL_EMPLOYER_NAME\"\n    ));\n\n    Map specialAttributesHCMName = new HashMap();\n    specialAttributesHCMName.put(\"ASSIGNMENT_ACTION_CODE\",\"ActionCode\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_BUSINESS_UNIT_ID\",\"BusinessUnitId\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_DEPARTMENT_ID\",\"DepartmentId\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_EFFECTIVE_END_DATE\",\"EffectiveEndDate\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_EFFECTIVE_START_DATE\" ,\"EffectiveStartDate\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_JOB_ID\",\"JobId\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_LOCATION_ID\",\"LocationId\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_NAME\",\"AssignmentName\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_NUMBER\",\"AssignmentNumber\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_POSITION_ID\",\"PositionId\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_STATUS\",\"AssignmentStatusType\");\n    specialAttributesHCMName.put(\"ASSIGNMENT_STATUS_TYPE_ID\",\"AssignmentStatusTypeId\");\n    specialAttributesHCMName.put(\"DEPARTMENT_NAME\",\"DepartmentName\");\n    specialAttributesHCMName.put(\"HIRE_DATE\",\"StartDate\");\n    specialAttributesHCMName.put(\"LEGISLATION_CODE\",\"LegislationCode\");\n    specialAttributesHCMName.put(\"LEGAL_ENTITY_ID\",\"LegalEntityId\");\n    specialAttributesHCMName.put(\"TERMINATION_DATE\",\"TerminationDate\");\n    specialAttributesHCMName.put(\"WORKER_TYPE\",\"WorkerType\");\n    specialAttributesHCMName.put(\"LEGAL_EMPLOYER_NAME\",\"LegalEmployerName\");\n    \n    Map employeesAssignments = getEmployeesAssignments();\n    //sbLogMessages.append(\"employeesAssignments: \" + employeesAssignments.toString() + System.lineSeparator());\n    //throw new GeneralException (sbLogMessages.toString());\n    \n    try {\n        if (processedResponseObject != null) {\n            for (Map iterateMap : processedResponseObject) {\n                sbLogMessages.setLength(0);\n                if (iterateMap != null) {\n                    String PERSON_NUMBER = iterateMap.get(\"PERSON_NUMBER\");\n                    ArrayList listASSIGNMENT_NUMBER = iterateMap.get(\"ASSIGNMENT_NUMBER\");\n                    sbLogMessages.append(\"PERSON_NUMBER: \" + PERSON_NUMBER.toString() + System.lineSeparator());\n\n                    int indexOfLatestASSIGNMENT_NUMBER = 0;\n                    String latestAssignment = \"\";\n\n                    if (listASSIGNMENT_NUMBER != null && !listASSIGNMENT_NUMBER.isEmpty()) {\n                        for (int i = 0; i < listASSIGNMENT_NUMBER.size(); i++) {\n                            String anASSIGNMENT_NUMBER = listASSIGNMENT_NUMBER.get(i); \n                            if (anASSIGNMENT_NUMBER.compareTo(latestAssignment) > 0 ){\n                                latestAssignment = anASSIGNMENT_NUMBER;\n                                indexOfLatestASSIGNMENT_NUMBER = i;\n                            }\n                        }\n                        sbLogMessages.append(\"latestAssignment: \" + latestAssignment.toString() + System.lineSeparator());\n\n                        for(String attName : specialAttributes){\n                            String key = PERSON_NUMBER + \"|\" + latestAssignment;\n                            sbLogMessages.append(\"key: \" + key.toString() + System.lineSeparator());\n                            String attHCMName = specialAttributesHCMName.get(attName);\n                            String attValue = null;\n                            try{\n                                sbLogMessages.append(\"Getting attribute: \" + attHCMName.toString() + System.lineSeparator());\n                                attValue = employeesAssignments.get(key).get(attHCMName);\n                                sbLogMessages.append(\"Getting value: \" + (attValue != null ? attValue.toString() : \"Null\") + System.lineSeparator());\n                            } finally {\n                                iterateMap.put(attName, attValue);\n                            }\n                        }\n                    }\n                    //Parse all attributes and remove square brackets (no multivalue attributes present)\n                    Set keySet = iterateMap.keySet();\n                    for (String theAttribute: keySet) {\n                        if (iterateMap.get(theAttribute) != null && iterateMap.get(theAttribute).getClass().getName().equals(\"java.util.ArrayList\") && iterateMap.get(theAttribute).size() > 0 ) {\n                                iterateMap.put(theAttribute, iterateMap.get(theAttribute).get(0));\n                        } \n                    }\n                }\n            }\n            updatedMapInfo.put(\"data\", processedResponseObject);\n        }\n    } catch (Exception e) {\n        throw new GeneralException (sbLogMessages + \"; Error: \" + e);\n    }\n    sbLogMessages.append(\"updatedMapInfo: \" + updatedMapInfo.toString() + System.lineSeparator());\n    //throw new GeneralException (sbLogMessages.toString());\n    return updatedMapInfo;\n}\nreturn Main();\n"
  },
  "attributes": {
    "sourceVersion": "1.0"
  },
  "id": "f62cdd5739524c19980f2144a49eb4a2",
  "name": "Oracle HCM WS AfterOperation",
  "created": "2023-06-27T16:16:12.202Z",
  "modified": "2023-11-13T21:55:18.292Z"
}