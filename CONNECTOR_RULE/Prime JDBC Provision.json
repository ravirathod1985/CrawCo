{
  "description": "This JDBC rule can process account creation requests, deletion requests, and modification requests that pertain to the role attribute. It logs debug messages if other account request types are submitted.",
  "type": "JDBCProvision",
  "signature": {
    "input": [
      {
        "name": "log",
        "description": "The log object associated with the SailPointContext.",
        "type": null
      },
      {
        "name": "context",
        "description": "A sailpoint.api.SailPointContext object that can be used to query the database if necessary.\n  ",
        "type": null
      },
      {
        "name": "application",
        "description": "The application whose data file is being processed.",
        "type": null
      },
      {
        "name": "schema",
        "description": "The Schema currently in use.",
        "type": null
      },
      {
        "name": "connection",
        "description": "A connection object to connect to database.",
        "type": null
      },
      {
        "name": "plan",
        "description": "The ProvisioningPlan created against the JDBC application.",
        "type": null
      }
    ],
    "output": {
      "name": "result",
      "description": "A Provisioning Result object is desirable to return the status.IT can be a new object or part of  Provisioning Plan",
      "type": null
    }
  },
  "sourceCode": {
    "version": "1.0",
    "script": "import java.sql.Connection;\nimport java.sql.DriverManager;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.ResultSetMetaData;\nimport java.sql.SQLException;\nimport java.sql.Types;\nimport java.sql.Date;\nimport java.sql.Timestamp;\nimport java.time.LocalDateTime;\nimport java.time.OffsetDateTime;\nimport java.time.format.DateTimeFormatter;\nimport java.util.List;\nimport java.util.Date;\nimport sailpoint.api.SailPointContext;\nimport sailpoint.connector.JDBCConnector;\nimport sailpoint.object.Application;\nimport sailpoint.object.ProvisioningPlan;\nimport sailpoint.object.ProvisioningPlan.AccountRequest;\nimport sailpoint.object.ProvisioningPlan.AttributeRequest;\nimport sailpoint.object.ProvisioningPlan.PermissionRequest;\nimport sailpoint.object.ProvisioningResult;\nimport sailpoint.object.Schema;\n\npublic boolean isEmpty(Object[] array) {\n  return (array == null || array.length == 0);\n}\n\npublic boolean isEmpty(Object obj) {\n  if (obj == null) {\n    return true;\n  }\n\n  if (obj.getClass().isArray()) {\n    return Array.getLength(obj) == 0;\n  }\n  if (obj instanceof CharSequence) {\n    return ((CharSequence) obj).length() == 0;\n  }\n  if (obj instanceof Collection) {\n    return ((Collection) obj).isEmpty();\n  }\n  if (obj instanceof Map) {\n    return ((Map) obj).isEmpty();\n  }\n  // else\n  return false;\n}\n\npublic String getAttributeRequestValue(AccountRequest acctReq, String attribute) {\n\n  if ( acctReq != null ) {\n    AttributeRequest attrReq = acctReq.getAttributeRequest(attribute);\n    if ( attrReq != null ) {\n      return attrReq.getValue();\n    }\n  }\n  return null;\n}\nprivate static java.sql.Date getCurrentDate() {\n    java.util.Date today = new java.util.Date();\n    return new java.sql.Date(today.getTime());\n}\n\npublic String[] getExchangeRate(){\n  //GETTING THE Employee_Code\n  String Exchange_rate_id = \"NOT FOUND\";\n  String Exchange_rate = \"NOT FOUND\";\n  String exchangeRateSelectStatement = \"SELECT TOP 1 [Exchange_rate_id],[Exchange_rate] FROM [dbo].[EXCHANGE_RATE] WHERE [From_currency_code] = 'GBP' AND [Exchange_rate_date] <= GETDATE() ORDER BY [Exchange_rate_date] desc\";\n\n  try{\n    statement = connection.prepareStatement(exchangeRateSelectStatement);\n    ResultSet resultSet = statement.executeQuery();\n    if(resultSet.next()){\n      Exchange_rate_id = resultSet.getString( \"Exchange_rate_id\" );\n      Exchange_rate = resultSet.getString( \"Exchange_rate\" );\n    }\n  }catch( SQLException e ) {\n    return new String[] { \"ERROR: \" + e.getMessage(), \"\", \"\" };\n  }\n\n  return new String[] { \"SUCCESS\", Exchange_rate_id,Exchange_rate};\n}\n\npublic String buildSQLCommand(AccountRequest acctReq, List tableColumnsKeys,List tableColumnsDetails, String tableName, String sqlStatement, ProvisioningResult result) {\n  result.addError(\"buildSQLCommand, tableName: \" + tableName);\n\tList columnNames = new ArrayList();\n\tList valueText = new ArrayList();\n\tList attrReqs = acctReq.getAttributeRequests();\n\tString columnName  = null;\n  String sqlStatementType = sqlStatement.split(\" \", 2)[0].toUpperCase();\n\n\tif ((attrReqs != null) && (attrReqs.size() > 0)) {\n\t\tfor(AttributeRequest attrReq : attrReqs) {\n\t\t\tcolumnName  = attrReq.getName();\n      String operation = attrReq.getOperation().toString(); //Remove or Add\n      //result.addError(\"buildSQLCommand, columnName: \" + columnName);\n\t\t\tif(tableColumnsKeys.contains(tableName + \".\" + columnName)){\n        int theIndex = tableColumnsKeys.indexOf(tableName + \".\" + columnName);\n        if(operation.equals(\"Add\") || (operation.equals(\"Remove\") && tableColumnsDetails.get(theIndex).toString().contains(\",conversion:YN\"))){\n          columnName = sqlStatementType.equals(\"UPDATE\") ? columnName + \" = ?\" : columnName;\n          columnNames.add(columnName);\n          valueText.add(\"?\");\n        }\n        //result.addError(\"buildSQLCommand, columnName after: \" + columnName);\n\t\t\t}\n\t\t}\n    if(!isEmpty(columnNames)){\n    //CHECK REQUIRED COLUMNS, ADD THEM IF NECESSARY ONLY IF IT IS AN INSERT \n\t\t\tif(sqlStatementType.equals(\"INSERT\")){\n\t\t\t\tfor(Object requiredColumn : tableColumnsDetails){ //FOR EACH DEFINED COLUMN DETAILS\n\t\t\t\t\tString tableColumnKey = tableColumnsKeys.get(tableColumnsDetails.indexOf(requiredColumn.toString()));\n\t\t\t\t\tString requiredColumnName = tableColumnKey.split(\"\\\\.\")[1];\n\t\t\t\t\tString requiredColumnTable = tableColumnKey.split(\"\\\\.\")[0];\n\t\t\t\t\tif(requiredColumnTable.contains(tableName) && requiredColumn.contains(\"required:true\") && !columnNames.contains(requiredColumnName)){\n\t\t\t\t\t\tcolumnNames.add(requiredColumnName);\n\t\t\t\t\t\tvalueText.add(\"?\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t//\\CHECK REQUIRED COLUMNS, ADD THEM IF NECESSARY\n\t\t\tString sql;\n\t\t\tif(sqlStatementType.equals(\"UPDATE\")){\n\t\t\t\tsql = sqlStatement.replace(\"COLUMN_NAMES_AND_VALUES\", String.join(\",\",columnNames));  \n\t\t\t}else{\n\t\t\t\tsql = sqlStatement.replace(\"COLUMN_NAMES\", String.join(\",\",columnNames)).replace(\"VALUE_TEXT\", String.join(\",\",valueText));\n\t\t\t}\n\t\t\treturn sql;\n\t\t}else{\n\t\t\treturn null;\n\t\t}\n\t}\n}\n\npublic List getSQLParameters(AccountRequest acctReq, List tableColumnsKeys,List tableColumnsDetails, String tableName, String sqlStatement, ProvisioningResult result) {\n\n\tList columnNames = new ArrayList();\n\tList parameters = new ArrayList();\n\tList attrReqs = acctReq.getAttributeRequests();\n  String sqlStatementType = sqlStatement.split(\" \", 2)[0].toUpperCase();\n\tString theValue = null;\n\tif ((attrReqs != null) && (attrReqs.size() > 0)) {\n\t\tString columnName  = null;\n\t\tfor(AttributeRequest attrReq : attrReqs) {\n\t\t\tcolumnName  = attrReq.getName();\n      String operation = attrReq.getOperation().toString(); //Remove or Add\n\t\t\t//String columnDetails = String.format(\"{table:%1$s,columnName:%2$s,source:ProvisioningPlan,\",tableName,columnName);\n\t\t\tif(tableColumnsKeys.contains(tableName + \".\" + columnName)){\n\t\t\t\tint theIndex = tableColumnsKeys.indexOf(tableName + \".\" + columnName);\n        if(operation.equals(\"Add\") || (operation.equals(\"Remove\") && tableColumnsDetails.get(theIndex).toString().contains(\",conversion:YN\"))){\n          columnNames.add(columnName);\n          if(tableColumnsDetails.get(theIndex).toString().contains(\",conversion:YN\")){\n            if(operation.equals(\"Add\")){\n              theValue = attrReq.getValue().toString();\n              theValue = theValue == null || theValue.isEmpty() ? \"N\" : \"Y\";\n              parameters.add(theValue);\n            }else{\n              parameters.add(\"N\");\n            }\n          }else if(tableColumnsDetails.get(theIndex).toString().contains(\",conversion:datetime\")){\n            theValue = attrReq.getValue().toString();\n            OffsetDateTime odt = OffsetDateTime.parse(theValue);\n            DateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyyMMdd hh:mm:ss\");\n            parameters.add(formatter.format(odt));\n          }else if(tableColumnsDetails.get(theIndex).toString().contains(\",conversion:static\")){\n            theValue = \"<replace>\";\n            parameters.add(theValue);\n          }else if(tableColumnsDetails.get(theIndex).toString().contains(\",conversion:exchange_rate_id\")){\n            String[] exchangeRate =  getExchangeRate();\n            if(exchangeRate[0].contains(\"SUCCESS\")){\n              theValue = exchangeRate[1];\n            }else{\n              result.addError(\"exchangeRate:\" + exchangeRate[0]);\n              theValue = \"0\";\n            }\n            parameters.add(theValue); \n          }else{\n            parameters.add(attrReq.getValue().toString());\n          }\n        }\n\t\t\t}\n\t\t}\n    if(!isEmpty(columnNames)){\n\t\t//CHECK REQUIRED COLUMNS, ADD THEM IF NECESSARY ONLY IF IT IS AN INSERT \n      if(sqlStatementType.equals(\"INSERT\")){\n        for(Object requiredColumn : tableColumnsDetails){ //FOR EACH DEFINED COLUMN DETAILS\n          String tableColumnKey = tableColumnsKeys.get(tableColumnsDetails.indexOf(requiredColumn.toString()));\n          String requiredColumnName = tableColumnKey.split(\"\\\\.\")[1];\n          if(requiredColumn.contains(\"table:\" + tableName + \",\") && requiredColumn.contains(\"required:true\")){\n            if(!columnNames.contains(requiredColumnName)){\n              if(requiredColumn.contains(\",conversion:YN\")){\n                theValue = \"N\";\n                parameters.add(theValue);\n              }else if(requiredColumn.contains(\",conversion:datetime\")){\n                Object objTimestamp = java.sql.Timestamp.valueOf(java.time.LocalDateTime.now());\n                parameters.add(objTimestamp);\n          }else if(requiredColumn.contains(\",conversion:static\")){\n            theValue = \"<replace>\";\n            parameters.add(theValue);\n          }else{\n            theValue = \"0\";\n            parameters.add(theValue);\n                }\n            }\n          }\n        }\n      }\n    //\\CHECK REQUIRED COLUMNS, ADD THEM IF NECESSARY\n    }\n\t}\n\n\tif (parameters != null && !parameters.isEmpty()) {\n      return parameters;\n\t}else{\n      return Collections.emptyList(); \n\t}\n}\n\npublic int updateRecord(AccountRequest acctReq, List tableColumnsKeys,List tableColumnsDetails, String tableName, String sqlStatement, ProvisioningResult result){\n\tString sql = buildSQLCommand(acctReq, tableColumnsKeys, tableColumnsDetails,tableName, sqlStatement, result);\n  result.addError(\"SQL update for \" + tableName + \" table: \" + sql);\n\tif (sql == null){\n\t\treturn 0;\n\t}\n\tList parameters = getSQLParameters(acctReq, tableColumnsKeys,tableColumnsDetails, tableName, sqlStatement, result);\n\tparameters.add(acctReq.getNativeIdentity()); //SET THE Employee_Code/ACCOUNT_ID FOR THE WHERE CLAUSE\n\tstatement = connection.prepareStatement(sql);\n\tint parameterCount = 1;\n\tList stringValues = new ArrayList();\n\tString theValue = null;\n\tfor (Object value : parameters) {\n    theValue = value.toString();\n    if(theValue.contains(\"<replace>\")){\n      theValue = acctReq.getNativeIdentity();\n      value = theValue;\n    }\n    stringValues.add(theValue);\n    statement.setObject(parameterCount++, value);\n\t}\n\tresult.addError(\"The values: \" + String.join(\",\",stringValues));\n\ttry{\n    statement.executeUpdate();\n\t}catch( SQLException e ) {\n\t\tresult.addError( \"Error on update: \" + e.getMessage() );\n\t\tresult.setStatus( ProvisioningResult.STATUS_FAILED );\n\t\treturn -1;\n\t}\n\tstatement.close();\n\tresult.setStatus( ProvisioningResult.STATUS_COMMITTED );\n\t//result.setStatus( ProvisioningResult.STATUS_FAILED );\n\treturn 1;\n}\n\nProvisioningResult result = new ProvisioningResult();\nPreparedStatement statement;\nString theValue = \"\" ;\n\nString selectStatement = \"SELECT \"\n                        + \"Employee_code, CTHG_Employee_Code\"\n                        + \" FROM [dbo].[EMPLOYEE] WHERE CTHG_Employee_Code = ?\";\n\nString selectStatementAPPLICATION_USER = \"SELECT * \"\n                        + \" FROM [dbo].[APPLICATION_USER] WHERE Employee_Code = ?\";\n\n\nList tableColumnsKeys = new ArrayList();\n//COLUMNS FOR TABLE: EMPLOYEE\ntableColumnsKeys.add(\"EMPLOYEE.CTHG_Employee_Code\");\ntableColumnsKeys.add(\"EMPLOYEE.Accounting_centre_id\");\ntableColumnsKeys.add(\"EMPLOYEE.Employee_grade_code\");\ntableColumnsKeys.add(\"EMPLOYEE.Forename\");\ntableColumnsKeys.add(\"EMPLOYEE.Job_title_code\");\ntableColumnsKeys.add(\"EMPLOYEE.Start_Date\");\ntableColumnsKeys.add(\"EMPLOYEE.Surname\");\ntableColumnsKeys.add(\"EMPLOYEE.Travel_charge_out_rate\");\ntableColumnsKeys.add(\"EMPLOYEE.Work_email_addr\");\ntableColumnsKeys.add(\"EMPLOYEE.Charge_out_rate_ere_id\");\ntableColumnsKeys.add(\"EMPLOYEE.Last_updated_id\");\ntableColumnsKeys.add(\"EMPLOYEE.Work_tel_no\");\ntableColumnsKeys.add(\"EMPLOYEE.Last_updated_time\");\ntableColumnsKeys.add(\"EMPLOYEE.Charge_out_rate\");\ntableColumnsKeys.add(\"EMPLOYEE.Charge_rate_time_period_code\");\ntableColumnsKeys.add(\"EMPLOYEE.Left_ind\");\ntableColumnsKeys.add(\"EMPLOYEE.Title_code\");\ntableColumnsKeys.add(\"EMPLOYEE.Travel_charge_out_rate_ere_id\");\ntableColumnsKeys.add(\"EMPLOYEE.Travel_charge_out_rate_time_period_code\");\ntableColumnsKeys.add(\"EMPLOYEE.Work_tel_IDC\");\n//COLUMNS FOR TABLE: APPLICATION_USER\ntableColumnsKeys.add(\"APPLICATION_USER.Employee_code\");\ntableColumnsKeys.add(\"APPLICATION_USER.User_name\");\ntableColumnsKeys.add(\"APPLICATION_USER.Logon_name\");\ntableColumnsKeys.add(\"APPLICATION_USER.Payment_limit\");\ntableColumnsKeys.add(\"APPLICATION_USER.Profile_id\");\ntableColumnsKeys.add(\"APPLICATION_USER.User_status\");\ntableColumnsKeys.add(\"APPLICATION_USER.Last_updated_id\");\ntableColumnsKeys.add(\"APPLICATION_USER.Logon_attempts\");\ntableColumnsKeys.add(\"APPLICATION_USER.Current_password\");\ntableColumnsKeys.add(\"APPLICATION_USER.Creation_time\");\ntableColumnsKeys.add(\"APPLICATION_USER.Last_updated_time\");\ntableColumnsKeys.add(\"APPLICATION_USER.Change_password\");\ntableColumnsKeys.add(\"APPLICATION_USER.Interactive_user\");\ntableColumnsKeys.add(\"APPLICATION_USER.Creation_id\");\n//REQUIERED COLUMNS SHOULD BE AT THE END\ntableColumnsKeys.add(\"APPLICATION_USER.Must_View_VAT_Advisory_Ind\");\ntableColumnsKeys.add(\"APPLICATION_USER.Allow_Credit_Note_Ind\");\ntableColumnsKeys.add(\"APPLICATION_USER.Allow_Invoice_Ind\");\ntableColumnsKeys.add(\"APPLICATION_USER.Employee_code\");\n\nList tableColumns = new ArrayList();\n//COLUMNS FOR TABLE: EMPLOYEE\ntableColumns.add(\"{table:EMPLOYEE,columnName:CTHG_Employee_Code,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Accounting_centre_id,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Employee_grade_code,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Forename,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Job_title_code,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Start_Date,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Surname,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Travel_charge_out_rate,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Work_email_addr,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Charge_out_rate_ere_id,source:ProvisioningPlan,conversion:exchange_rate_id\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Last_updated_id,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Work_tel_no,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Last_updated_time,source:ProvisioningPlan,conversion:datetime\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Charge_out_rate,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Charge_rate_time_period_code,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Left_ind,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Title_code,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Travel_charge_out_rate_ere_id,source:ProvisioningPlan,conversion:exchange_rate_id\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Travel_charge_out_rate_time_period_code,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:EMPLOYEE,columnName:Work_tel_IDC,source:ProvisioningPlan,conversion:none\");\n//COLUMNS FOR TABLE: APPLICATION_USER\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Employee_code,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:User_name,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Logon_name,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Payment_limit,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Profile_id,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:User_status,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Last_updated_id,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Logon_attempts,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Current_password,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Creation_time,source:ProvisioningPlan,conversion:datetime\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Last_updated_time,source:ProvisioningPlan,conversion:datetime\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Change_password,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Interactive_user,source:ProvisioningPlan,conversion:none\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Creation_id,source:ProvisioningPlan,conversion:none\");\n//REQUIERED COLUMNS SHOULD BE AT THE END\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Must_View_VAT_Advisory_Ind,source:ProvisioningPlan,conversion:YN,required:true\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Allow_Credit_Note_Ind,source:ProvisioningPlan,conversion:YN,required:true\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Allow_Invoice_Ind,source:ProvisioningPlan,conversion:YN,required:true\");\ntableColumns.add(\"{table:APPLICATION_USER,columnName:Employee_code,source:ProvisioningPlan,conversion:static,required:true\");\n\nString deleteStatement = \"DELETE [dbo].[EMPLOYEE] WHERE Employee_Code = ?\";\n\nString tempSQLStatement = \" SELECT \"\n+ \"     c.name 'Column Name',\"\n+ \"     t.Name 'Data type',\"\n+ \"     c.max_length 'Max Length',\"\n+ \"     c.precision ,\"\n+ \"     c.scale ,\"\n+ \"     c.is_nullable,\"\n+ \"     ISNULL(i.is_primary_key, 0) 'Primary Key'\"\n+ \" FROM    \"\n+ \"     sys.columns c\"\n+ \" INNER JOIN \"\n+ \"     sys.types t ON c.user_type_id = t.user_type_id\"\n+ \" LEFT OUTER JOIN \"\n+ \"     sys.index_columns ic ON ic.object_id = c.object_id AND ic.column_id = c.column_id\"\n+ \" LEFT OUTER JOIN \"\n+ \"     sys.indexes i ON ic.object_id = i.object_id AND ic.index_id = i.index_id\"\n+ \" WHERE\"\n+ \"     c.object_id = OBJECT_ID('APPLICATION_USER')\";\n\ntempSQLStatement = \" SELECT TOP 2 \"\n                  + \"Employee_code\"\n                  + \",User_name\"\n                  + \",Allow_Credit_Note_Ind\"\n                  + \",Allow_Invoice_Ind\"\n                  + \",Logon_name\"\n                  + \",Must_View_VAT_Advisory_Ind\"\n                  + \",Payment_limit\"\n                  + \",Profile_id\"\n                  + \",User_id\"\n                  + \",User_status\"\n                  + \",Creation_id\"\n                  + \",Last_updated_id\"\n                  + \",Logon_attempts\"\n                  + \",Current_password\"\n                  + \",Creation_time\"\n                  + \",Last_updated_time\"\n                  + \",Change_password\"\n                  + \",Interactive_user\"\n                  + \" FROM APPLICATION_USER\";               \n\nif ( plan != null ) {\n  int theIndex = 1;\n  List accounts = plan.getAccountRequests();\n  if ( ( accounts != null ) && ( accounts.size() > 0 ) ) {\n    for ( AccountRequest account : accounts ) {\n      try {\n        if ( AccountRequest.Operation.Create.equals( account.getOperation() ) ) {\n          //--------------CREATE--------------------------------------------------------------------------------------          \n          String baseSql = \"INSERT INTO [dbo].[EMPLOYEE] (COLUMN_NAMES) VALUES (VALUE_TEXT)\";\n          String sql = buildSQLCommand(account, tableColumnsKeys, tableColumns,\"EMPLOYEE\", baseSql, result);\n          if (sql == null){\n            result.addError(\"ERROR ON CREATE: NO VALID ATTRIBUTES FOUND\");\n            result.setStatus( ProvisioningResult.STATUS_FAILED );\n            return result;\n          }\n          List parameters = getSQLParameters(account, tableColumnsKeys,tableColumns, \"EMPLOYEE\", baseSql, result);\n          result.addError(\"SQL for EMPLOYEE table: \" + sql);\n          statement = connection.prepareStatement(sql);\n          int parameterCount = 1;\n          List stringValues = new ArrayList();\n          for (Object value : parameters) {\n            stringValues.add(value.toString());\n            statement.setObject(parameterCount++, value);\n          }\n          result.addError(\"The values: \" + String.join(\",\",stringValues));\n          try{\n            statement.executeUpdate();\n          }catch( SQLException e ) {\n            result.addError( \"Error on insert: \" + e.getMessage() );\n            result.setStatus( ProvisioningResult.STATUS_FAILED );\n            return result;\n            //throw new Exception (\">>>ERROR ON INSERT: \" + e.getMessage());\n          }\n          statement.close();\n\n          //GETTING THE Employee_Code\n          String objectId = \"\";\n          try{\n            statement = connection.prepareStatement(selectStatement);\n            statement.setString ( 1, getAttributeRequestValue(account,\"CTHG_Employee_Code\") );\n            //statement.setObject ( 2,Integer.parseInt(getAttributeRequestValue(account,\"CTHG_Employee_Code\")),java.sql.Types.NUMERIC \n            ResultSet resultSet = statement.executeQuery();\n            objectId = resultSet.next() ? resultSet.getString( \"Employee_Code\" ) : \"NOT FOUND\";\n            result.addError(\"The Employee Code: \" + objectId);\n          }catch( SQLException e ) {\n            result.addError( \"Error on select statement: \" + e.getMessage() );\n            result.setStatus( ProvisioningResult.STATUS_FAILED );\n            //throw new Exception (\">>>ERROR GETTING Employee_Code: \" + e.getMessage());\n            return result;\n          }\n          if( objectId != \"NOT FOUND\" ) {\n            //Insert into table APPLICATION_USER =================================================\n            result.addError(\"Inserting into app_user. Employee_Code: \" + objectId);\n            baseSql = \"INSERT INTO [dbo].[APPLICATION_USER] (COLUMN_NAMES) VALUES (VALUE_TEXT)\";\n            sql = buildSQLCommand(account, tableColumnsKeys, tableColumns,\"APPLICATION_USER\", baseSql, result);\n            if (sql == null){\n              result.addError(\"ERROR ON CREATE: NO VALID ATTRIBUTES FOUND\");\n              result.setStatus( ProvisioningResult.STATUS_FAILED );\n              return result;\n            }\n            List parameters = getSQLParameters(account, tableColumnsKeys,tableColumns, \"APPLICATION_USER\", baseSql, result);\n            result.addError(\"SQL for APPLICATION_USER table: \" + sql);\n//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n//result.setStatus( ProvisioningResult.STATUS_FAILED );\n//return result;\n//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n            statement = connection.prepareStatement(sql);\n            int parameterCount = 1;\n            List stringValues = new ArrayList();\n            String theValue = null;\n            for (Object value : parameters) {\n              theValue = value.toString();\n              if(theValue.contains(\"<replace>\")){\n                theValue = objectId;\n                value = theValue;\n              }\n              stringValues.add(theValue);\n              statement.setObject(parameterCount++, value);\n            }\n            result.addError(\"The values: \" + String.join(\",\",stringValues));\n            try{\n              statement.executeUpdate();\n            }catch( SQLException e ) {\n              result.addError( \"Error on insert: \" + e.getMessage() );\n              result.setStatus( ProvisioningResult.STATUS_FAILED );\n              return result;\n            }\n            statement.close();\n            result.setStatus( ProvisioningResult.STATUS_COMMITTED );\n            result.addError(\"--after insert ua--\");\n            return result;\n          }else{\n            result.addError(\"ERROR: ACCOUNT NOT FOUND\");\n            result.setStatus( ProvisioningResult.STATUS_FAILED);\n            return result;\n          }\n\n        } else if ( AccountRequest.Operation.Modify.equals( account.getOperation() ) ) {\n          //--------------Modify--------------------------------------------------------------------------------------\n\n          result.addError(\"Updating account\");\n          String baseSql = \"UPDATE [dbo].[EMPLOYEE] SET COLUMN_NAMES_AND_VALUES WHERE Employee_Code = ?\";\n          if(updateRecord(account, tableColumnsKeys, tableColumns,\"EMPLOYEE\", baseSql, result) < 0){\n            result.addError(\"Error updating EMPLOYEE table.\");\n            result.setStatus( ProvisioningResult.STATUS_FAILED);\n            return result;\n          }\n          \n          baseSql = \"UPDATE [dbo].[APPLICATION_USER] SET COLUMN_NAMES_AND_VALUES WHERE Employee_Code = ?\";\n          if(updateRecord(account, tableColumnsKeys, tableColumns,\"APPLICATION_USER\", baseSql, result) < 0){\n            result.addError(\"Error updating APPLICATION_USER table.\");\n            result.setStatus( ProvisioningResult.STATUS_FAILED);\n            return result;\n          }\n          \n          result.addError(\"--after insert ua--\");\n          result.setStatus( ProvisioningResult.STATUS_COMMITTED );\n          return result;\n\n        } else if ( AccountRequest.Operation.Delete.equals( account.getOperation() ) ) {\n          //--------------Delete--------------------------------------------------------------------------------------          \n          // Delete, not supported.\n\n        } else if ( AccountRequest.Operation.Disable.equals( account.getOperation() ) ) {\n          //--------------Disable--------------------------------------------------------------------------------------\n          String disableStatement = \"UPDATE [dbo].[APPLICATION_USER] SET User_status = ? WHERE Employee_Code = ?\";          \n          statement = connection.prepareStatement(disableStatement);\n          statement.setString ( 1, \"DISB\" );\n          statement.setString ( 2, account.getNativeIdentity() );\n          statement.executeUpdate();\n          result.setStatus( ProvisioningResult.STATUS_COMMITTED );\n\n        } else if ( AccountRequest.Operation.Enable.equals( account.getOperation() ) ) {\n          //-----TESTING \n          // String[] exchangeRate =  getExchangeRate();\n          // if(exchangeRate[0].contains(\"SUCCESS\")){\n          //   result.addError(\"exchangeRate:\" + String.join(\" \", exchangeRate()));\n          // }else{\n          //   result.addError(\"exchangeRate:\" + exchangeRate[0]);\n          // }\n          //-----\\TESTING\n          //--------------Enable--------------------------------------------------------------------------------------   \n          String enableStatement = \"UPDATE [dbo].[APPLICATION_USER] SET User_status = ? WHERE Employee_Code = ?\";       \n          statement = connection.prepareStatement(enableStatement);\n          statement.setString ( 1, \"ACTV\" );\n          statement.setString ( 2, account.getNativeIdentity() );\n          statement.executeUpdate();\n          result.setStatus( ProvisioningResult.STATUS_COMMITTED );\n          statement.close();\n\n        } else if ( AccountRequest.Operation.Lock.equals( account.getOperation() ) ) {\n        //--------------Lock--------------------------------------------------------------------------------------          \n\n          // Lock, not supported.\n\n        } else if ( AccountRequest.Operation.Unlock.equals( account.getOperation() ) ) {\n        //--------------Unlock--------------------------------------------------------------------------------------          \n\n          // Unlock, not supported.\n\n        } else {\n          \n          // Unknown operation!\n        \n        }\n      }\n      catch( SQLException e ) {\n        result.setStatus( ProvisioningResult.STATUS_FAILED );\n        result.addError( e );\n      }\n      finally {\n        if(statement != null) {\n          statement.close();\n        }\n      }\n    }\n  }\n}\n\nreturn result;"
  },
  "attributes": {
    "sourceVersion": "1.0"
  },
  "id": "5d3753a0094243af8fe9c55819d7aa30",
  "name": "Prime JDBC Provision",
  "created": "2022-07-24T18:57:54.106Z",
  "modified": "2022-10-25T05:13:43.886Z"
}