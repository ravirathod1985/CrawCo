{
  "description": "This rule is used by the Web Services connector to update parsed resource object. Create List of Objects which will later converted to Resource object.",
  "type": "WebServiceAfterOperationRule",
  "signature": {
    "input": [
      {
        "name": "application",
        "description": "The application whose data file is being processed.",
        "type": null
      },
      {
        "name": "requestEndPoint",
        "description": "The current request information contain header, body ,response object",
        "type": null
      },
      {
        "name": "processedResponseObject",
        "description": "Response Object processed by the Web services connector",
        "type": null
      },
      {
        "name": "rawResponseObject",
        "description": "Response Object returned from the end system",
        "type": null
      },
      {
        "name": "restClient",
        "description": "REST Client Object",
        "type": null
      }
    ],
    "output": {
      "name": "Update Account/Group List",
      "description": "Update information Map contains parsed list of accounts",
      "type": null
    }
  },
  "sourceCode": {
    "version": "1.0",
    "script": "import java.util.ArrayList;\r\nimport java.util.HashMap;\r\nimport java.util.List;\r\nimport java.util.Map;\r\nimport java.util.Set;\r\nimport sailpoint.tools.GeneralException;\r\nimport connector.common.JsonUtil;\r\n\r\npublic Map getEmployeesAssignments(){\r\n    StringBuilder sbLogMessages = new StringBuilder();\r\n\r\n    ArrayList<String> specialAttributesFromWorkrelation = new ArrayList<String>(\r\n            Arrays.asList(\"StartDate\", \"LegislationCode\", \"LegalEntityId\", \"TerminationDate\", \"WorkerType\",\"LegalEmployerName\"));\r\n\r\n    ArrayList<String> specialAttributesFromAssignment = new ArrayList<String>(\r\n            Arrays.asList(\"ActionCode\", \"BusinessUnitId\", \"DepartmentId\", \"EffectiveEndDate\", \"EffectiveStartDate\",\r\n                    \"JobId\", \"LocationId\", \"AssignmentName\", \"AssignmentNumber\", \"PositionId\",\r\n                    \"AssignmentStatusType\", \"AssignmentStatusTypeId\", \"DepartmentName\"));\r\n\r\n    Map EmployeesAssignments = new HashMap();\r\n\r\n    Map response = JsonUtil.toMap(rawResponseObject);\r\n\r\n    try{\r\n        if (response.get(\"items\") != null) {\r\n            List items = (ArrayList) response.get(\"items\");\r\n            for (int d = 0; d < items.size(); d++) {\r\n                Map worker = (Map) items.get(d);\r\n                // items[d].workrelationships.items[e].assignments.items[f]\r\n                if (((Map) worker.get(\"workRelationships\")).get(\"items\") != null) {\r\n                    List workRelationships = (ArrayList) ((Map) worker.get(\"workRelationships\")).get(\"items\");\r\n                    for (int e = 0; e < workRelationships.size(); e++) {\r\n                        Map workRelation = (Map) workRelationships.get(e);\r\n                        if (((Map) workRelation.get(\"assignments\")).get(\"items\") != null) {\r\n                            List assignments = (ArrayList) ((Map) workRelation.get(\"assignments\")).get(\"items\");\r\n                            for (int f = 0; f < assignments.size(); f++) {\r\n                                Map assignment = (Map) assignments.get(f);\r\n                                String key = \"\";\r\n                                key = worker.get(\"PersonNumber\") + \"|\" + String.valueOf(assignment.get(\"AssignmentNumber\"));\r\n                                Map newMap = new HashMap();\r\n                                newMap.put(\"PersonNumber\", String.valueOf(worker.get(\"PersonNumber\")));\r\n                                newMap.put(\"PeriodOfServiceId\", String.valueOf(workRelation.get(\"PeriodOfServiceId\")));\r\n                                newMap.put(\"AssignmentNumber\", (String) assignment.get(\"AssignmentNumber\"));\r\n                                for (String attName : specialAttributesFromWorkrelation) {\r\n                                    String attValue = null;\r\n                                    if (workRelation.get(attName) != null){\r\n                                        attValue = String.valueOf(workRelation.get(attName));\r\n                                    }\r\n                                    newMap.put(attName, attValue);\r\n                                }\r\n                                for (String attName : specialAttributesFromAssignment) {\r\n                                    String attValue = null;\r\n                                    if (assignment.get(attName) != null){\r\n                                        attValue = String.valueOf(assignment.get(attName));\r\n                                    }\r\n                                    newMap.put(attName, attValue);\r\n                                }\r\n                                EmployeesAssignments.put(key, newMap);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return EmployeesAssignments;\r\n    } catch (Exception e) {\r\n        sbLogMessages.append(\"@getEmployeesAssignments\" + System.lineSeparator());\r\n        throw new GeneralException (sbLogMessages + \"; Error: \" + e);\r\n    }\r\n}\r\n\r\npublic Map Main(){\r\n    Map updatedMapInfo = new HashMap();\r\n    StringBuilder sbLogMessages = new StringBuilder();\r\n    \r\n    // sbLogMessages.append(\"processedResponseObject: \" + processedResponseObject.toString() + System.lineSeparator());\r\n    // sbLogMessages.append(\"rawResponseObject: \" + rawResponseObject.toString() + System.lineSeparator());\r\n    // throw new GeneralException (sbLogMessages.toString());\r\n\r\n    ArrayList<String> specialAttributes = new ArrayList<String>(Arrays.asList(\r\n        \"ASSIGNMENT_ACTION_CODE\",\r\n        \"ASSIGNMENT_BUSINESS_UNIT_ID\",\r\n        \"ASSIGNMENT_DEPARTMENT_ID\",\r\n        \"ASSIGNMENT_EFFECTIVE_END_DATE\",\r\n        \"ASSIGNMENT_EFFECTIVE_START_DATE\",\r\n        \"ASSIGNMENT_JOB_ID\",\r\n        \"ASSIGNMENT_LOCATION_ID\",\r\n        \"ASSIGNMENT_NAME\",\r\n        \"ASSIGNMENT_NUMBER\",\r\n        \"ASSIGNMENT_POSITION_ID\",\r\n        \"ASSIGNMENT_STATUS\",\r\n        \"ASSIGNMENT_STATUS_TYPE_ID\",\r\n        \"DEPARTMENT_NAME\",\r\n        \"HIRE_DATE\",\r\n        \"LEGAL_ENTITY_ID\",\r\n        \"LEGISLATION_CODE\",\r\n        \"WORKER_TYPE\",\r\n        \"TERMINATION_DATE\",\r\n        \"LEGAL_EMPLOYER_NAME\"\r\n    ));\r\n\r\n    Map specialAttributesHCMName = new HashMap();\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_ACTION_CODE\",\"ActionCode\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_BUSINESS_UNIT_ID\",\"BusinessUnitId\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_DEPARTMENT_ID\",\"DepartmentId\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_EFFECTIVE_END_DATE\",\"EffectiveEndDate\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_EFFECTIVE_START_DATE\" ,\"EffectiveStartDate\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_JOB_ID\",\"JobId\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_LOCATION_ID\",\"LocationId\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_NAME\",\"AssignmentName\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_NUMBER\",\"AssignmentNumber\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_POSITION_ID\",\"PositionId\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_STATUS\",\"AssignmentStatusType\");\r\n    specialAttributesHCMName.put(\"ASSIGNMENT_STATUS_TYPE_ID\",\"AssignmentStatusTypeId\");\r\n    specialAttributesHCMName.put(\"DEPARTMENT_NAME\",\"DepartmentName\");\r\n    specialAttributesHCMName.put(\"HIRE_DATE\",\"StartDate\");\r\n    specialAttributesHCMName.put(\"LEGISLATION_CODE\",\"LegislationCode\");\r\n    specialAttributesHCMName.put(\"LEGAL_ENTITY_ID\",\"LegalEntityId\");\r\n    specialAttributesHCMName.put(\"TERMINATION_DATE\",\"TerminationDate\");\r\n    specialAttributesHCMName.put(\"WORKER_TYPE\",\"WorkerType\");\r\n    specialAttributesHCMName.put(\"LEGAL_EMPLOYER_NAME\",\"LegalEmployerName\");\r\n    \r\n    Map employeesAssignments = getEmployeesAssignments();\r\n    //sbLogMessages.append(\"employeesAssignments: \" + employeesAssignments.toString() + System.lineSeparator());\r\n    //throw new GeneralException (sbLogMessages.toString());\r\n    \r\n    try {\r\n        if (processedResponseObject != null) {\r\n            for (Map iterateMap : processedResponseObject) {\r\n                sbLogMessages.setLength(0);\r\n                if (iterateMap != null) {\r\n                    String PERSON_NUMBER = iterateMap.get(\"PERSON_NUMBER\");\r\n                    ArrayList listASSIGNMENT_NUMBER = iterateMap.get(\"ASSIGNMENT_NUMBER\");\r\n                    sbLogMessages.append(\"PERSON_NUMBER: \" + PERSON_NUMBER.toString() + System.lineSeparator());\r\n\r\n                    int indexOfLatestASSIGNMENT_NUMBER = 0;\r\n                    String latestAssignment = \"\";\r\n\r\n                    if (listASSIGNMENT_NUMBER != null && !listASSIGNMENT_NUMBER.isEmpty()) {\r\n                        for (int i = 0; i < listASSIGNMENT_NUMBER.size(); i++) {\r\n                            String anASSIGNMENT_NUMBER = listASSIGNMENT_NUMBER.get(i); \r\n                            if (anASSIGNMENT_NUMBER.compareTo(latestAssignment) > 0 ){\r\n                                latestAssignment = anASSIGNMENT_NUMBER;\r\n                                indexOfLatestASSIGNMENT_NUMBER = i;\r\n                            }\r\n                        }\r\n                        sbLogMessages.append(\"latestAssignment: \" + latestAssignment.toString() + System.lineSeparator());\r\n\r\n                        for(String attName : specialAttributes){\r\n                            String key = PERSON_NUMBER + \"|\" + latestAssignment;\r\n                            sbLogMessages.append(\"key: \" + key.toString() + System.lineSeparator());\r\n                            String attHCMName = specialAttributesHCMName.get(attName);\r\n                            String attValue = null;\r\n                            try{\r\n                                sbLogMessages.append(\"Getting attribute: \" + attHCMName.toString() + System.lineSeparator());\r\n                                attValue = employeesAssignments.get(key).get(attHCMName);\r\n                                sbLogMessages.append(\"Getting value: \" + (attValue != null ? attValue.toString() : \"Null\") + System.lineSeparator());\r\n                            } finally {\r\n                                iterateMap.put(attName, attValue);\r\n                            }\r\n                        }\r\n                    }\r\n                    //Parse all attributes and remove square brackets (no multivalue attributes present)\r\n                    Set keySet = iterateMap.keySet();\r\n                    for (String theAttribute: keySet) {\r\n                        if (iterateMap.get(theAttribute) != null && iterateMap.get(theAttribute).getClass().getName().equals(\"java.util.ArrayList\") && iterateMap.get(theAttribute).size() > 0 ) {\r\n                                iterateMap.put(theAttribute, iterateMap.get(theAttribute).get(0));\r\n                        } \r\n                    }\r\n                }\r\n            }\r\n            updatedMapInfo.put(\"data\", processedResponseObject);\r\n        }\r\n    } catch (Exception e) {\r\n        throw new GeneralException (sbLogMessages + \"; Error: \" + e);\r\n    }\r\n    sbLogMessages.append(\"updatedMapInfo: \" + updatedMapInfo.toString() + System.lineSeparator());\r\n    throw new GeneralException (sbLogMessages.toString());\r\n    //return updatedMapInfo;\r\n}\r\nreturn Main();\r\n"
  },
  "attributes": {
    "sourceVersion": "1.0"
  },
  "id": "e1108e94da374ddba0e25cca2b90eb75",
  "name": "Oracle HCM WS AfterOperation - TEST TEMP",
  "created": "2023-10-04T16:55:10.490Z",
  "modified": "2023-10-04T17:25:55.030Z"
}